# 作業範囲書（SOW） - Issue #17

## 作業概要
- Issue番号: #17
- 目的: NipponCode実行エンジンの複数の重大な問題を修正し、実用レベルまで品質を向上させる
- スコープ: 対話型チャットシステムの入力処理、エラーハンドリング、コマンド実行管理、コンテキスト管理、セッション継続性の改善

## 既存コード分析

### 影響を受けるファイル
1. `src/commands/interactive-chat.ts` (820行) - メインの対話型チャットUI
2. `src/agents/chat.ts` (272行) - チャットエージェントロジック
3. `src/session/simple-manager.ts` - セッション管理
4. `src/execution/autonomous-agent.ts` - 自律実行エージェント
5. `src/execution/command-executor.ts` - コマンド実行管理

### 現在の実装の仕組み
- **入力処理**: readline.Interfaceを使用した行単位の入力処理（行174-224）
- **複数行入力**: "```"マーカーによる複数行モード（行179-218）
- **エラー処理**: try-catchによる基本的なエラーハンドリング（行431-448）
- **コマンド実行**: 同期的な実行フロー、バックグラウンド実行の未実装
- **セッション管理**: SimpleSessionManagerによる基本的なセッション保存

### 依存関係
- readline (Node.js標準ライブラリ)
- child_process (コマンド実行用)
- fs-extra (ファイル操作)
- chalk (ターミナル出力装飾)

## リスク評価
- デグレードの可能性: **Medium** - 対話型インターフェースの挙動変更
- 影響範囲: チャット機能全体、タスク実行フロー
- 軽減策: 段階的な実装、既存機能の互換性維持、十分なテスト

## 設計思想

### アーキテクチャ
1. **入力バッファリングシステム**
   - 分割された入力を結合する一時バッファ
   - タイムアウトベースの自動結合メカニズム
   - ペースト検出とマルチライン処理の統合

2. **エラーリカバリーシステム**
   - エラーコンテキストの自動検出
   - 実行履歴と作成ファイルの関連付け
   - 自動修正提案と再実行メカニズム

3. **非同期コマンド実行**
   - child_process.spawn()によるdetached実行
   - タイムアウト管理とプロセス監視
   - 出力バッファリングとストリーミング

4. **コンテキスト管理強化**
   - 実行履歴の永続化
   - ファイル変更トラッキング
   - エラーとコンテキストの自動関連付け

5. **セッション継続性**
   - 自動セッション保存（定期的 + 終了時）
   - クラッシュリカバリー
   - 実行状態の復元

### 保守性
- モジュラー設計による機能分離
- イベント駆動アーキテクチャによる疎結合
- 明確なエラー境界とリカバリーポイント

### ベストプラクティス（リサーチ結果）
1. **Node.js readline複数行入力処理（2025年）**
   - 'line'イベントで配列に収集、'close'イベントで処理
   - Async/Awaitパターンによるクリーンな非同期処理
   - メモリ効率的な大量入力処理

2. **長時間実行コマンドの非ブロッキング処理**
   - child_process.spawn()でdetachedオプション使用
   - subprocess.unref()による親プロセスの独立
   - キューベースのバックグラウンド処理

3. **エラーリカバリーとコンテキスト保持**
   - 集中型エラーハンドリングオブジェクト
   - オペレーショナルエラーとプログラマーエラーの区別
   - セッションデータの永続化と復元

## 受け入れ基準

### 機能要件
- [ ] ペーストされた複数行入力が分割されずに処理される
- [ ] エラー発生時に自動的にコンテキストを保持し修正を試みる
- [ ] flask runなどの長時間実行コマンドがブロッキングしない
- [ ] 作成したファイルの内容を記憶し、エラー時に参照できる
- [ ] セッションが自動保存され、クラッシュ後も継続可能

### 非機能要件
- [ ] 入力レスポンスタイム < 100ms
- [ ] メモリリーク防止（長時間実行でも安定）
- [ ] プロセス管理の適切な実装（ゾンビプロセス防止）

### テストケース
1. 複数行エラーメッセージのペーストテスト
2. 長時間実行コマンドの非ブロッキング実行テスト
3. エラー後の自動修正フローテスト
4. セッションリカバリーテスト
5. メモリリークテスト（長時間実行）

## 実装計画

### Phase 1: 入力処理の改善
1. 入力バッファリングシステムの実装
2. ペースト検出メカニズムの追加
3. 複数行入力の結合ロジック強化

### Phase 2: エラー処理の改善
1. エラーコンテキストトラッカーの実装
2. 自動修正提案システムの構築
3. エラーリカバリーフローの実装

### Phase 3: 非同期実行の実装
1. CommandExecutorの非同期化
2. プロセス管理システムの実装
3. 出力ストリーミングの実装

### Phase 4: コンテキスト管理
1. 実行履歴管理システムの実装
2. ファイル変更トラッキングの追加
3. コンテキスト関連付けエンジンの実装

### Phase 5: セッション継続性
1. 自動セッション保存機能の実装
2. クラッシュリカバリーの実装
3. 状態復元メカニズムの構築

## 参考資料
- Node.js v24.6.0 Documentation - Readline
- Node.js v24.6.0 Documentation - Child Process
- Node.js Best Practices (2025)
- OWASP Session Management Cheat Sheet
# NipponCode 実装詳細と技術的考慮事項

## 1. 現在の実装状態

### 1.1 実装済み機能
- ✅ 基本的なチャット機能
- ✅ OpenAI API統合
- ✅ ストリーミング対応
- ✅ セッション管理（基本）
- ✅ 設定管理システム
- ✅ コマンドラインインターフェース

### 1.2 未実装機能
- ❌ Anthropic API統合
- ❌ コード生成・編集機能
- ❌ ファイル操作機能
- ❌ プロジェクト分析（実装はあるが未接続）
- ❌ テスト
- ❌ エラーリカバリー機構

## 2. 技術スタック

### 2.1 主要依存関係
```json
{
  "typescript": "^5.9.2",      // 型安全性
  "commander": "^11.1.0",      // CLIフレームワーク
  "inquirer": "^9.2.12",       // 対話的プロンプト
  "axios": "^1.6.2",           // HTTPクライアント
  "chalk": "^5.3.0",           // カラー出力
  "tiktoken": "^1.0.11",       // トークン数推定
  "dotenv": "^16.3.1",         // 環境変数管理
  "fs-extra": "^11.2.0",       // ファイル操作拡張
  "marked": "^11.0.0",         // Markdown処理
  "ora": "^8.0.1"              // スピナー表示
}
```

### 2.2 開発ツール
- TypeScript: 型安全性の確保
- ESLint: コード品質管理
- Jest: テストフレームワーク（設定済み、未使用）
- tsx: 開発時の直接実行

## 3. 実装パターンと設計決定

### 3.1 非同期処理
#### 選択: async/await パターン
**理由**: 
- コードの可読性向上
- エラーハンドリングの簡潔性
- TypeScriptとの親和性

#### 実装例:
```typescript
async chat(message: string): Promise<string> {
  this.addMessage('user', message);
  const messages = this.buildMessages();
  const response = await this.provider.complete(options);
  this.addMessage('assistant', response.content);
  return response.content;
}
```

### 3.2 ストリーミング処理
#### 選択: AsyncGenerator パターン
**理由**:
- メモリ効率的な処理
- リアルタイム応答の実現
- 中断可能な処理

#### 実装例:
```typescript
async *streamChat(message: string): AsyncGenerator<string> {
  for await (const chunk of this.provider.streamComplete(options)) {
    if (!chunk.done && chunk.content) {
      yield chunk.content;
    }
  }
}
```

### 3.3 設定管理
#### 選択: Singleton パターン
**理由**:
- グローバル状態の一元管理
- メモリ効率
- 設定の一貫性保証

### 3.4 プロバイダー抽象化
#### 選択: Strategy パターン + Abstract Factory
**理由**:
- 複数AIプロバイダーの切り替え容易性
- 新プロバイダーの追加が簡単
- テスタビリティの向上

## 4. 重要な実装詳細

### 4.1 トークン管理ロジック

**ファイル**: `src/agents/chat.ts` (buildMessages メソッド)

```typescript
// トークン数計算フロー
1. システムプロンプトのトークン数を計算
2. コンテキストのトークン数を追加
3. 利用可能トークン = 最大トークン - 予約トークン
4. 新しいメッセージから順に、トークン制限内で追加
```

**課題**: 
- 日本語のトークン数推定が不正確な可能性
- コンテキストが大きい場合の処理

### 4.2 SSE (Server-Sent Events) パース

**ファイル**: `src/providers/openai.ts` (streamComplete メソッド)

```typescript
// SSEパースロジック
let buffer = '';
for await (const chunk of response.data) {
  buffer += chunk.toString();
  const lines = buffer.split('\n');
  buffer = lines.pop() || '';
  // 各行を処理...
}
```

**注意点**:
- バッファリングによるメモリ使用
- 不完全なJSONの処理
- エラーハンドリング

### 4.3 セッション永続化

**現状**: 基本実装のみ
**課題**:
- 大きなセッションファイルの処理
- 同時アクセス時の競合状態
- 暗号化の未実装

## 5. パフォーマンス考慮事項

### 5.1 メモリ管理
- **問題**: 長い会話でのメモリ増加
- **対策**: メッセージ履歴の自動トリミング
- **実装**: トークン数ベースの制限

### 5.2 レスポンス時間
- **問題**: API呼び出しのレイテンシ
- **対策**: ストリーミング応答の実装
- **改善案**: キャッシュ機構の追加

### 5.3 ファイルI/O
- **問題**: 大規模プロジェクトの分析時間
- **対策**: 並列処理（p-limit使用）
- **改善案**: インクリメンタル分析

## 6. セキュリティ考慮事項

### 6.1 APIキー管理
**現在の実装**:
- 環境変数での管理
- 設定ファイルでの保存（平文）
- 表示時のマスキング

**改善案**:
- キーチェーン/資格情報マネージャー統合
- 暗号化された設定ファイル

### 6.2 入力検証
**現在の実装**:
- 基本的な設定値検証

**必要な改善**:
- コマンドインジェクション対策
- パストラバーサル対策
- APIレスポンスの検証強化

## 7. 既知の問題と技術的負債

### 7.1 高優先度
1. **エラーハンドリング不足**
   - API失敗時のリトライなし
   - ネットワークエラーの適切な処理なし

2. **テストの欠如**
   - 単体テストなし
   - 統合テストなし

### 7.2 中優先度
1. **コード重複**
   - session/manager.ts と simple-manager.ts

2. **型安全性の改善余地**
   - any型の使用箇所あり

### 7.3 低優先度
1. **ログ機能の不足**
   - デバッグログなし
   - 監査ログなし

2. **国際化（i18n）**
   - ハードコードされた日本語メッセージ

## 8. 将来の技術的改善案

### 8.1 アーキテクチャ改善
- **イベント駆動アーキテクチャ**: プラグインシステムの実装
- **マイクロサービス化**: プロバイダーの分離
- **WebSocket対応**: リアルタイム通信の改善

### 8.2 機能拡張
- **プラグインシステム**: 拡張機能の追加を容易に
- **Web UI**: ブラウザベースのインターフェース
- **VSCode拡張**: IDE統合

### 8.3 パフォーマンス最適化
- **レスポンスキャッシュ**: 類似質問への高速応答
- **並列処理の強化**: Worker Threadsの活用
- **ストリーミング最適化**: バックプレッシャー制御

## 9. デバッグとトラブルシューティング

### 9.1 デバッグ方法
```bash
# デバッグモード有効化
export VLLM_DEBUG=true

# 詳細ログ出力
npm run dev -- --verbose
```

### 9.2 一般的な問題
1. **APIキーエラー**
   - 環境変数の確認
   - 設定ファイルの確認

2. **トークン制限エラー**
   - maxTokens設定の調整
   - メッセージ履歴のクリア

3. **ストリーミングエラー**
   - ネットワーク設定の確認
   - タイムアウト設定の調整

## 10. コーディング規約

### 10.1 命名規則
- クラス: PascalCase
- メソッド/変数: camelCase
- 定数: UPPER_SNAKE_CASE
- ファイル: kebab-case

### 10.2 コード構造
- 1ファイル1クラス/モジュール
- exportは最下部にまとめる
- importは種類別にグループ化

### 10.3 コメント
- JSDocコメントの使用
- 複雑なロジックには説明コメント
- TODOコメントの活用

---
更新日: 2025-08-20
バージョン: 0.1.0